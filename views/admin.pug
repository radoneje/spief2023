extends layout
block head
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-rbsA2VBKQhggwzxH7pPCaAqO46MgnOM80zW1RWuH61DGLwZJEdK2Kadq2F9CUG65" crossorigin="anonymous">

block content
    .mt-2
        input.btn.btn-success(type="button" value="Скачать эксель" onclick="window.open('/spief2023/trExcel')")
    .mt-2
        input.btn.btn-success(type="button" value="Скачать эксель SberTv" onclick="window.open('/spief2023/trSbertvExcel')")
    form.mt-2(method="POST" action="/spief2023/admin/AddSession")

        input.btn.btn-success(type="submit" value="Добавить сессию")

    .mt-2.adminTransWr

        each tr in translations
            .transItem.recWr(id="tr" + tr.id trid=tr.id)
                .transItemLang
                    .transId.mb-2 ID: #{tr.id}ru
                    .transItemTitleWr
                        input.transDate.full(value=tr.date name="date"  placeholder="ДД / HH:MM")
                        input.transTitle.full(value=tr.title name="title" placeholder="название")
                        input.transTitle.full(value=tr.shortName name="shortName" placeholder="короткое название")
                        textarea.transUrl(value=tr.descr name="descr"  placeholder="описание")
                    .adminCol.mt-2
                        .adminRow
                            .transItemStatusW.mt-2
                                select.transItemStatus(name="status" value=tr.status)
                                    option(value="0"  selected=tr.status == 0) Выключена
                                    option(value="1"  selected=tr.status == 1) Постер
                                    option(value="2" selected=tr.status == 2) Эфир
                                    option(value="3" selected=tr.status == 3) Запись
                            //.transItemStatusW.mt-2
                              input.transDate(value=tr.key name="key"  placeholder="CDN KEY")
                        .adminIframe
                            .videoWr
                                iframe(src="/spief2023/player/" + tr.id width="1289" height="720" allowfullscreen)
                    .transItemStatusW.mt-2
                        div
                            label Poster
                            input.transUrl(value=tr.poster name="poster"  placeholder="Постер")
                    .transItemStatusW.mt-2
                        div
                            label ВК Ссылка на видео (поделиться->экспортировать->Прямая ссылка)
                            input.transUrl(value=tr.vklink_ru name="vklink_ru"  placeholder="Вставьте ссылку")
                    .transItemStatusW.mt-2
                        div
                            label ВК Настройки трансляции -> KEY
                            input.transUrl(value=tr.restream_ru name="restream_ru"  placeholder="Вставьте ключ трансляции")
                    .transItemStatusW.mt-2
                        div
                            label ВК IFRAME (поделиться->экспортировать->код для вставки)
                            textarea.transUrl(value=tr.iframe name="iframe"  placeholder="Вставьте код Iframe")
                    .transItemStatusW.mt-2
                        div
                            label Ссылка на СберТВ
                            input.transUrl(value=tr.sbertv_ru name="sbertv_ru"  placeholder="Вставьте ссылку")
                    .transItemStatusW.mt-2
                        div
                            h6 запись ru
                            .btn.btn-sm.btn-success.mt-2 Добавить запись

                .transItemLang
                    .transId.mb-2 ID: #{tr.id}en
                    .transItemTitleWr
                        input.transDate.full(value=tr.date_en name="date_en"  placeholder="Date")
                        input.transTitle.full(value=tr.title_en name="title_en" placeholder="Title")
                        input.transTitle.full(value=tr.shortName_en name="shortName_en" placeholder="Short Title")
                        textarea.transUrl(value=tr.descr_en name="descr_en"  placeholder="Description")
                    .adminCol.mt-2
                        .adminRow
                            //.transItemStatusW.mt-2
                              select.transItemStatus(name="status" value=tr.status)
                                option(value="0"  selected=tr.status == 0) Выключена
                                option(value="1"  selected=tr.status == 1) Постер
                                option(value="2" selected=tr.status == 2) Эфир
                                option(value="3" selected=tr.status == 3) Запись
                            //.transItemStatusW.mt-2
                              input.transDate(value=tr.key name="key"  placeholder="CDN KEY")
                        .adminIframe
                            .videoWr
                                iframe(src="/spief2023/player_en/" + tr.id width="1289" height="720" allowfullscreen)
                    .transItemStatusW.mt-2
                        div
                            label Poster
                            input.transUrl(value=tr.poster_en name="poster_en"  placeholder="Poster")
                    .transItemStatusW.mt-2
                        div
                            label ВК Link to Video (поделиться->экспортировать->Прямая ссылка)
                            input.transUrl(value=tr.vklink_en name="vklink_en"  placeholder="Paste Link" )
                    .transItemStatusW.mt-2
                        div
                            label ВК Настройки трансляции -> KEY
                            input.transUrl(value=tr.restream_en name="restream_en"  placeholder="Paste  key")
                    .transItemStatusW.mt-2
                        div
                            label VK IFRAME (поделиться->экспортировать->код для вставки)
                            textarea.transUrl(value=tr.iframe_en name="iframe_en"  placeholder="Paste  Iframe code")
                    .transItemStatusW.mt-2
                        div
                            label Link to  SberTv
                            input.transUrl(value=tr.sbertv_en name="sbertv_en"  placeholder="Paste link")
                    .transItemStatusW.mt-2
                        div
                            h6 En record
                            .btn.btn-sm.btn-success.mt-2 ADD Record



    script.
        const updateStatus = async () => {
            let res = await fetch("/spief2023/trStatusAll")
            if (res.ok) {
                let data = await res.json();
                data.forEach(tr => {
                    let wr = document.querySelector("#tr" + tr.id)
                    if (wr) {
                        let names = (Object.keys(tr))
                        names.forEach(name => {
                            let elem = wr.querySelector("[name='" + name + "']")
                            if (elem && document.activeElement != elem) {
                                elem.value = tr[name]

                            }
                        })

                    }
                })
            }
            setTimeout(updateStatus, 10 * 1000)
        }
        document.querySelectorAll(".adminTransWr input[name], .adminTransWr select[name], .adminTransWr textarea[name]").forEach(e => {
            e.onchange = async () => {
                let id = e.closest(".transItem").getAttribute("trid");
                let name = e.getAttribute("name")
                let data = {id}
                data[name] = e.value;
                let res = await fetch("/spief2023/changeTr", {
                    body: JSON.stringify(data),
                    method: "POST",
                    headers: {"Content-Type": "application/json"}
                })
                if (res.ok)
                    console.log(await res.text())
            }

        })
        updateStatus();

