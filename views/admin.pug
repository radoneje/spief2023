extends layout
block head
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-rbsA2VBKQhggwzxH7pPCaAqO46MgnOM80zW1RWuH61DGLwZJEdK2Kadq2F9CUG65" crossorigin="anonymous">

block content
  form.mt-2(method="POST" action="/spief2023/admin/AddSession")
    input.btn.btn-success(type="submit" value="Добавить сессию")
  .mt-2.transWr
    each tr in translations
      .transItem(id="tr"+tr.id trid=tr.id)
        .transItemTitleWr
          input.transDate(value=tr.date name="date"  placeholder="ДД / HH:MM")
          input.transTitle(value=tr.title name="title" placeholder="название")
        .transItemStatusW.mt-2
          select.transItemStatus(name="status" value=tr.status)
            option(value="1"  selected=tr.status==1) Постер
            option(value="2" selected=tr.status==2) Эфир
            option(value="3" selected=tr.status==3) Запись
        .transItemStatusW.mt-2
          input.transDate(value=tr.key name="key"  placeholder="CDN KEY")
        .transItemStatusW.mt-2
          div
            label Poster
            input.transUrl(value=tr.poster name="poster"  placeholder="Poster")
        .transItemStatusW.mt-2
          div
            label Live HLS
            input.transUrl(value=tr.hls name="hls"  placeholder="hls")
        .transItemStatusW.mt-2
          div
            label Rec mp4
            input.transUrl(value=tr.video name="video"  placeholder="video")
  script.
    const updateStatus=async()=>{
      let res = await fetch("/spief2023/trStatusAll")
      if(res.ok){
        let data=await res.json();
        data.forEach(tr=>{
          let wr=document.querySelector("#tr"+tr.id)
          if(wr){
           let names =(Object.keys(tr))
            names.forEach(name=>{
              let elem=wr.querySelector("[name='"+name+"']")
              if(elem &&document.activeElement != elem){
                elem.value=tr[name]

              }
            })

          }
        })
      }
      setTimeout(updateStatus, 10*1000)
    }
    document.querySelectorAll(".transWr input[name], .transWr select[name]").forEach(e=>{
      e.onchange=async()=>{
        let id=e.closest(".transItem").getAttribute("trid");
        let name=e.getAttribute("name")
        let data={id}
        data[name]=e.value;
        let res=await fetch("/spief2023/changeTr",{body: JSON.stringify(data), method: "POST",headers:{"Content-Type": "application/json"}})
        if(res.ok)
          console.log(await res.text())
      }

    })
    updateStatus();

